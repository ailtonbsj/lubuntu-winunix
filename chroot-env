#!/bin/bash

mount -t proc none /proc
mount -t sysfs none /sys
mount -t devpts none /dev/pts

echo "Inside the belly of the beast..."

echo "Avoid problems of languages in GPG keys"
export HOME=/root
export LC_ALL=C
dbus-uuidgen > /var/lib/dbus/machine-id
dpkg-divert --local --rename --add /sbin/initctl
ln -s /bin/true /sbin/initctl

# Customizations
HASPROXY=$(cat /etc/apt/apt.conf | grep "Acquire::http::proxy" | wc -l)
if [ "$HASPROXY" == "1" ]; then
	HTTPPROXY=$(cat /etc/apt/apt.conf | grep "Acquire::http::proxy" | awk '{split($0,a,"\""); print a[2]}')
	HTTPSROXY=$(cat /etc/apt/apt.conf | grep "Acquire::https::proxy" | awk '{split($0,a,"\""); print a[2]}')
	export http_proxy=${HTTPROXY%?};
	export https_proxy=${HTTPSROXY%?};
fi

## Timezone
ln -sf /usr/share/zoneinfo/America/Fortaleza /etc/localtime

## Set Language
locale-gen pt_BR.UTF-8
update-locale LANG=\"pt_BR.UTF-8\" LANGUAGE=\"pt_BR:\"

## Avoid problems with internet
STAT=`grep '#dns=dnsmasq' /etc/NetworkManager/NetworkManager.conf`
if [ "$STAT" == "" ]; then
	sed -i 's/dns=dnsmasq/#dns=dnsmasq/g' /etc/NetworkManager/NetworkManager.conf
	sudo chmod 644 /etc/NetworkManager/NetworkManager.conf
	service network-manager restart
	sleep 5
fi

## Remove apps
aptRemove () {
	apt remove --purge $1 -y  2>&1 >/tmp/aptlog
}

aptRemove "kcalc"
aptRemove "qlipper"
aptRemove "noblenote"
aptRemove "trojita"
aptRemove "quassel"
aptRemove "2048-qt"
aptRemove "ark"
aptRemove "qapt-deb-installer"
aptRemove "ttf-mscorefonts-installer"
aptRemove "libreoffice-qt5"
# aptRemove "screengrab"
rm -rf /usr/share/applications/info.desktop

## Adding Repositories
dpkg --add-architecture i386

### WinuniX focal repository
wget -qO - "https://winunix.github.io/debian/public.key" | sudo apt-key add -
sudo echo "deb https://winunix.github.io/debian focal main" > /etc/apt/sources.list.d/winunix-focal.list

### AnyDesk all repository
wget -qO - "https://keys.anydesk.com/repos/DEB-GPG-KEY" | sudo apt-key add -
sudo echo "deb http://deb.anydesk.com/ all main" > /etc/apt/sources.list.d/anydesk-stable.list

### Java ppa repository 'sudo add-apt-repository ppa:linuxuprising/java -y'
wget -qO - "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x1cc3d16e460a94ee17fe581cea8cacc073c3db2a" | sudo apt-key add -
sudo echo "deb http://ppa.launchpad.net/linuxuprising/java/ubuntu focal main" > /etc/apt/sources.list.d/linuxuprising-ubuntu-java-focal.list

apt-get update >/tmp/aptlog

## upgrade of system
#apt-mark hold grub-*
apt-get upgrade -y
#apt-mark unhold grub-*

## Install apps
aptInstall () {
	sudo DEBIAN_FRONTEND=noninteractive apt install $1 -y 2>&1 >/tmp/aptlog
}

## Reconfigure apps
dpkgReconf () {
	sudo DEBIAN_FRONTEND=noninteractive dpkg-reconfigure $1 2>&1 >/tmp/aptlog
}

### TTF MS Core Fonts
echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections
aptInstall "ttf-mscorefonts-installer"
echo ttf-mscorefonts-installer msttcorefonts/dldir select "/tmp/mscoref" | debconf-set-selections
dpkgReconf "ttf-mscorefonts-installer"

### Language
aptInstall "language-pack-pt"
aptInstall "language-pack-br"
aptInstall "language-pack-pt-base"
aptInstall "language-pack-br-base"
aptInstall "language-pack-gnome-pt"
aptInstall "language-pack-gnome-br"
aptInstall "language-pack-gnome-pt-base"
aptInstall "language-pack-gnome-br-base"
aptInstall "language-pack-kde-pt"
aptInstall "hyphen-pt-pt"
aptInstall "hyphen-pt-br"
aptInstall "hunspell-br"
aptInstall "hunspell-pt-pt"
aptInstall "myspell-pt-br"
aptInstall "mythes-pt-pt"
aptInstall "wportuguese"
aptInstall "wbrazilian"
dpkgReconf "locales"

### Appearance
aptInstall "qt5-style-plugin-gtk2"
aptInstall "/tmp/lubuntu-win10-theme.deb"
aptInstall "/tmp/lubuntu-win8-cursor-theme.deb"
aptInstall "/tmp/lubuntu-win10-icon-theme.deb"
aptInstall "/tmp/lubuntu-win10-qt-theme.deb"
aptInstall "/tmp/sddm-theme-win10.deb"
aptInstall "/tmp/lubuntu-win-theme-apply.deb"

### Java
echo debconf shared/accepted-oracle-license-v1-2 select true | sudo debconf-set-selections
aptInstall "oracle-java14-installer"

### utils
aptInstall "gstreamer1.0-plugins-ugly"
aptInstall "gstreamer1.0-plugins-bad"
aptInstall "gstreamer1.0-libav"
aptInstall "rar"
aptInstall "unrar"
aptInstall "p7zip"
aptInstall "zenity"
aptInstall "traceroute"
aptInstall "net-tools"
aptInstall "cups"
aptInstall "openssh-server"
aptInstall "libnss3-tools"
aptInstall "apt-transport-https"
aptInstall "libpam-mount"
aptInstall "libpam-gnome-keyring"
aptInstall "smbclient"
aptInstall "samba"
aptInstall "libdvd-pkg"
dpkgReconf "libdvd-pkg"
aptInstall "python3-smbc"
aptInstall "mesa-utils"
aptInstall "xdg-utils"
aptInstall "curl"

### Drivers
aptInstall "bcmwl-kernel-source"

### Accessories
aptInstall "file-roller"
aptInstall "galculator"
aptInstall "xpad"
aptInstall "gnome-screenshot"
aptInstall "gnome-disk-utility"
aptInstall "gucharmap"
aptInstall "gnome-paint"
aptInstall "cheese"
aptInstall "hardinfo"
aptInstall "gdebi"

### Apps
aptInstall "firefox"
aptInstall "firefox-locale-pt"
aptInstall "firefox-locale-br"
aptInstall "vlc"
aptInstall "gimp"
aptInstall "inkscape"
aptInstall "evince"
aptInstall "openshot"
aptInstall "imagination"
aptInstall "libreoffice"
aptInstall "libreoffice-l10n-br"
aptInstall "libreoffice-l10n-pt-br"
aptInstall "openoffice.org-hyphenation"
aptInstall "eog"
aptInstall "flashplugin-installer"
aptInstall "rdesktop"
aptInstall "remmina"
aptInstall "remmina-plugin-rdp"
aptInstall "wine64"
aptInstall "wine32"
aptInstall "wine-stable"
aptInstall "lsb"
aptInstall "yad"
aptInstall "python-gi"
aptInstall "pdfshuffler"
aptInstall "audacious"
aptInstall "anydesk"
aptInstall "system-config-samba-focal"
aptInstall "nodejs"
aptInstall "npm"
aptInstall "xserver-xorg-input-synaptics"
aptInstall "cifs-utils"
aptInstall "fonts-3rd-party"
aptInstall "/tmp/google-chrome-stable.deb"
aptInstall "/tmp/visual-studio-code.deb"
aptInstall "/tmp/master-pdf-editor.deb"
aptInstall "/tmp/unetbootin.deb"
aptInstall "/tmp/wps-office-full.deb"

# aptInstall "/tmp/libpng12-0.deb"
# aptInstall "/tmp/rdesktop.deb" # usando xenial pois atual tem bug no winServer2003
# aptInstall "libgtk2.0-0:i386"
# aptInstall "libxft2:i386"
# aptInstall "libxt6:i386"
# Adobe Reader 8
# aptInstall "/tmp/adobeReader.deb"
# aptInstall "gtk2-engines-murrine:i386"
# aptInstall "gtk2-engines-pixbuf:i386"

## Apport
sed -i 's/enabled=1/enabled=0/g' /etc/default/apport
sudo chmod 644 /etc/default/apport

## Hardinfo icon
cp -f /usr/share/icons/win10-icons/48x48/devices/audio-card.png /usr/share/hardinfo/pixmaps/logo.png

## EoG light theme
sed -i "s#Exec=eog %U#Exec=env GTK_THEME=\"Windows 10 forLxde\" eog %U#g" /usr/share/applications/org.gnome.eog.desktop
sudo chmod 644 /usr/share/applications/org.gnome.eog.desktop

## Check Winunix Apps
chmod +x /usr/bin/verify-winunix

## Notifications of update
sed -i '/Prompt=/c\Prompt=never' /etc/update-manager/release-upgrades
sudo chmod 644 /etc/update-manager/release-upgrades
sed -i '/APT::Periodic::Update-Package-Lists/c\APT::Periodic::Update-Package-Lists "0";' /etc/apt/apt.conf.d/10periodic
sudo chmod 644 /etc/apt/apt.conf.d/10periodic

## Services
sudo systemctl disable anydesk.service
sudo systemctl disable sshd.service

## Fix Libreoffice export pdf
# hasEnvVar=`grep 'SAL_VCL_QT5_USE_CAIRO' /etc/environment`
# if [ "$hasEnvVar" == "" ]; then
# 	echo "SAL_VCL_QT5_USE_CAIRO=true" >> /etc/environment
# 	sudo chmod 644 /etc/environment
# fi

# copying confs from firefox and chrome
rm -rf /root/.config
rm -rf /root/.mozilla
cp -rf /etc/skel/.config /root
cp -rf /etc/skel/.mozilla /root

apt-get upgrade -y
apt-get autoremove -y
apt-get autoclean -y

# Cleaning chrome environment
rm -rf ~/.bash_history /tmp/*
rm /var/lib/dbus/machine-id
rm /sbin/initctl
rm /root/.wgetrc
rm -rf /root/.config
rm -rf /root/.mozilla
dpkg-divert --rename --remove /sbin/initctl

# Unmount specials files and exiting of chroot
while [ ! -z "$(ls -A /proc)" ]; do
	umount /proc
	umount -lf /proc
	sleep 1
done
while [ ! -z "$(ls -A /sys)" ]; do
	umount /sys
	umount -lf /sys
	sleep 1
done
while [ ! -z "$(ls -A /dev/pts)" ]; do
	umount /dev/pts
	umount -lf /dev/pts
	sleep 1
done
